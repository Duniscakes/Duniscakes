<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="duni's Cakes">
<title>duni's Cakes ‚Äì Panel de Gesti√≥n</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéÇ</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Jost:wght@300;400;500;600&display=swap" rel="stylesheet">
<script>
// Safari LockManager polyfill ‚Äî fix for Supabase session persistence
if (!navigator.locks) {
  navigator.locks = {
    request: (name, optionsOrCallback, callback) => {
      const cb = callback || optionsOrCallback;
      return Promise.resolve().then(() => cb({ name }));
    },
    query: () => Promise.resolve({ held: [], pending: [] })
  };
}
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* ====== LOGIN SCREEN ====== */
#login-screen{
  display:flex;align-items:center;justify-content:center;
  min-height:100vh;background:var(--bg);padding:20px;
}
.login-box{
  background:var(--surface);border:1px solid var(--border);
  border-radius:24px;padding:40px 36px;width:100%;max-width:420px;
  box-shadow:var(--shadow-hover);text-align:center;
}
.login-logo{font-size:3rem;margin-bottom:8px;}
.login-title{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:700;color:var(--rose-dark);margin-bottom:4px;}
.login-title em{font-style:italic;color:var(--blush);}
.login-sub{font-size:.75rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:32px;}
.login-tabs{display:flex;background:var(--surface2);border-radius:14px;padding:4px;margin-bottom:24px;gap:4px;}
.login-tab{flex:1;padding:8px;border-radius:10px;border:none;cursor:pointer;font-size:.85rem;font-weight:600;font-family:'Jost',sans-serif;background:transparent;color:var(--muted);transition:all .2s;}
.login-tab.active{background:var(--surface);color:var(--rose-dark);box-shadow:0 2px 8px rgba(100,20,40,.10);}
.login-form{display:flex;flex-direction:column;gap:14px;}
.login-form input{background:var(--input-bg);border:1px solid var(--border2);border-radius:12px;color:var(--text);padding:12px 16px;font-size:.9rem;font-family:'Jost',sans-serif;outline:none;transition:border-color .2s;}
.login-form input:focus{border-color:var(--rose);box-shadow:0 0 0 3px rgba(155,37,69,.10);}
.login-btn{background:linear-gradient(135deg,var(--rose-dark),var(--rose));color:white;border:none;border-radius:14px;padding:13px;font-size:.92rem;font-weight:600;font-family:'Jost',sans-serif;cursor:pointer;transition:all .2s;box-shadow:0 4px 16px rgba(110,20,48,.35);margin-top:4px;}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 6px 22px rgba(110,20,48,.45);}
.login-btn:disabled{opacity:.6;cursor:not-allowed;transform:none;}
.login-msg{font-size:.82rem;padding:10px 14px;border-radius:10px;margin-top:8px;display:none;}
.login-msg.error{background:rgba(155,37,69,.10);color:var(--rose-dark);border:1px solid rgba(155,37,69,.25);display:block;}
.login-msg.success{background:var(--sage-light);color:#5a8a60;border:1px solid rgba(90,138,96,.3);display:block;}
.login-footer{font-size:.7rem;color:var(--muted);margin-top:20px;}

/* ====== LIGHT THEME ====== */
[data-theme="light"] {
  --bg: #fdf7f8; --bg2: #f8eef1; --surface: #ffffff; --surface2: #f3e4e9;
  --border: #e2c8d0; --border2: #d4b0bc;
  --text: #2a0d15; --text2: #6b3040; --muted: #a87080; --white: #ffffff;
  --shadow: 0 4px 24px rgba(100,20,40,0.10); --shadow-hover: 0 8px 36px rgba(100,20,40,0.20);
  --logo-bg: linear-gradient(135deg,#f8eaee,#f0d8de); --table-head-bg: #f8eef1;
  --input-bg: #fdf7f8; --topbar-shadow: 0 2px 16px rgba(100,20,40,0.08);
  --sidebar-shadow: 2px 0 24px rgba(100,20,40,0.10);
  --nav-active-bg: #f3e4e9; --nav-hover-bg: #f3e4e9; --modal-backdrop: rgba(42,13,21,0.40);
}
/* ====== DARK THEME ====== */
[data-theme="dark"] {
  --bg: #140810; --bg2: #1c0e14; --surface: #221018; --surface2: #2c1520;
  --border: #3e1a26; --border2: #4e2232;
  --text: #f8eaee; --text2: #d4a0b0; --muted: #8a5060; --white: #221018;
  --shadow: 0 4px 24px rgba(0,0,0,0.40); --shadow-hover: 0 8px 36px rgba(0,0,0,0.55);
  --logo-bg: linear-gradient(135deg,#2a0e18,#380f20); --table-head-bg: #2c1520;
  --input-bg: #1c0e14; --topbar-shadow: 0 2px 12px rgba(0,0,0,0.40);
  --sidebar-shadow: 2px 0 20px rgba(0,0,0,0.40);
  --nav-active-bg: rgba(150,40,70,0.22); --nav-hover-bg: rgba(150,40,70,0.13);
  --modal-backdrop: rgba(0,0,0,0.70);
}
/* ====== BRAND COLORS ‚Äì duni's Cakes: Vinotinto Monocrom√°tico ====== */
:root {
  --rose:#9b2545;       /* vinotinto principal */
  --rose-dark:#6e1430;  /* vinotinto oscuro */
  --blush:#c25070;      /* vinotinto medio */
  --sage:#b06075;       /* vinotinto suave (reemplaza sage) */
  --lavender:#d4909f;   /* vinotinto claro (reemplaza lavender) */
  --caramel:#e8b8c2;    /* vinotinto muy claro (reemplaza caramel) */
}
[data-theme="light"] {
  --rose-light:#f3e4e9;
  --sage-light:#edd8de;
  --lavender-light:#f7eced;
  --caramel-light:#fdf3f5;
}
[data-theme="dark"] {
  --rose-light:rgba(155,37,69,0.22);
  --sage-light:rgba(176,96,117,0.18);
  --lavender-light:rgba(212,144,159,0.15);
  --caramel-light:rgba(232,184,194,0.12);
}

*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Jost',sans-serif;min-height:100vh;overflow-x:hidden;transition:background .3s,color .3s;}

/* SIDEBAR */
.sidebar{position:fixed;left:0;top:0;width:250px;height:100vh;background:linear-gradient(180deg,var(--surface) 0%,#f8eaee 100%);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:100;box-shadow:var(--sidebar-shadow);transition:background .3s,border-color .3s;}
.logo{padding:28px 24px 22px;border-bottom:1px solid var(--border);background:var(--logo-bg);}
.logo-icon{font-size:2rem;margin-bottom:8px;display:block;}
.logo h1{font-family:'Cormorant Garamond',serif;font-size:1.55rem;font-weight:700;color:var(--rose-dark);line-height:1;letter-spacing:-.5px;}
.logo h1 em{font-style:italic;color:var(--blush);}
.logo-sub{font-size:.68rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-top:4px;display:block;}
.nav{flex:1;padding:16px 0;overflow-y:auto;}
.nav-section-label{font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:2px;padding:12px 22px 4px;}
.nav-item{display:flex;align-items:center;gap:12px;padding:11px 22px;cursor:pointer;font-size:.87rem;color:var(--text2);transition:all .2s;border-left:3px solid transparent;margin:1px 0;}
.nav-item:hover{color:var(--rose-dark);background:var(--nav-hover-bg);}
.nav-item.active{color:var(--rose-dark);border-left-color:var(--rose);background:var(--nav-active-bg);font-weight:600;}
.nav-icon{font-size:1rem;width:20px;text-align:center;}
.sidebar-footer{padding:16px 22px;border-top:1px solid var(--border);font-size:.72rem;color:var(--muted);text-align:center;}

/* TOPBAR */
.main{margin-left:250px;min-height:100vh;}
.topbar{padding:14px 32px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--surface);position:sticky;top:0;z-index:50;box-shadow:var(--topbar-shadow);transition:background .3s;gap:16px;flex-wrap:wrap;}
.topbar-left h2{font-family:'Cormorant Garamond',serif;font-size:1.45rem;font-weight:600;color:var(--text);}
.topbar-date{font-size:.78rem;color:var(--muted);margin-top:1px;}
.topbar-right{display:flex;align-items:center;gap:10px;flex-shrink:0;flex-wrap:wrap;}

/* CURRENCY */
.currency-selector{display:flex;align-items:center;background:var(--surface2);border:1px solid var(--border2);border-radius:25px;overflow:hidden;}
.currency-btn{padding:6px 14px;font-size:.78rem;font-weight:600;font-family:'Jost',sans-serif;border:none;cursor:pointer;background:transparent;color:var(--muted);transition:all .2s;}
.currency-btn.active{background:linear-gradient(135deg,var(--rose),var(--blush));color:white;border-radius:25px;}
.currency-btn:hover:not(.active){color:var(--rose-dark);}
.tasa-wrap{display:flex;align-items:center;gap:6px;}
.tasa-wrap input{width:85px;padding:6px 10px;font-size:.8rem;border-radius:12px;}
.tasa-wrap span{font-size:.74rem;color:var(--muted);white-space:nowrap;}

/* DARK TOGGLE */
.theme-toggle{display:flex;align-items:center;gap:7px;padding:7px 14px;background:var(--surface2);border:1px solid var(--border2);border-radius:25px;cursor:pointer;font-size:.82rem;font-weight:500;color:var(--text2);transition:all .2s;font-family:'Jost',sans-serif;white-space:nowrap;}
.theme-toggle:hover{border-color:var(--rose);color:var(--rose-dark);}
.toggle-track{width:32px;height:17px;background:var(--border2);border-radius:20px;position:relative;transition:background .25s;flex-shrink:0;}
.toggle-thumb{position:absolute;top:2px;left:2px;width:13px;height:13px;border-radius:50%;background:white;transition:transform .25s;box-shadow:0 1px 4px rgba(0,0,0,.2);}
[data-theme="dark"] .toggle-track{background:var(--rose);}
[data-theme="dark"] .toggle-thumb{transform:translateX(15px);}

/* CONTENT */
.content{padding:28px 32px;}

/* KPI */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px;}
.kpi-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:var(--shadow);transition:all .25s;position:relative;overflow:hidden;}
.kpi-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;border-radius:0 0 16px 16px;}
.kpi-card.rose::after{background:linear-gradient(90deg,var(--rose),var(--blush));}
.kpi-card.sage::after{background:linear-gradient(90deg,var(--sage),var(--lavender));}
.kpi-card.caramel::after{background:linear-gradient(90deg,var(--caramel),var(--caramel));}
.kpi-card.lavender::after{background:linear-gradient(90deg,var(--lavender),#f5dde3);}
.kpi-card:hover{transform:translateY(-3px);box-shadow:var(--shadow-hover);}
.kpi-emoji{font-size:1.6rem;margin-bottom:10px;display:block;}
.kpi-label{font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;}
.kpi-value{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:700;line-height:1;}
.kpi-value.rose{color:var(--rose-dark);} .kpi-value.sage{color:var(--sage);} .kpi-value.caramel{color:var(--caramel);} .kpi-value.lavender{color:var(--lavender);}
.kpi-sub{font-size:.75rem;color:var(--muted);margin-top:6px;}

/* LAYOUT */
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;}

/* CARD */
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:22px;box-shadow:var(--shadow);transition:background .3s,border-color .3s;}
.card-title{font-family:'Cormorant Garamond',serif;font-size:1.1rem;font-weight:600;margin-bottom:18px;color:var(--text);display:flex;justify-content:space-between;align-items:center;}
.card-mb{margin-bottom:20px;}
.badge{font-family:'Jost',sans-serif;font-size:.68rem;padding:3px 10px;border-radius:20px;background:var(--rose-light);color:var(--rose-dark);font-weight:500;}

/* TABLE */
table{width:100%;border-collapse:collapse;font-size:.84rem;}
th{text-align:left;padding:8px 12px;color:var(--muted);font-weight:500;font-size:.7rem;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);background:var(--table-head-bg);}
td{padding:11px 12px;border-bottom:1px solid var(--border);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:var(--bg2);}

/* FORMS */
.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:14px;margin-bottom:16px;}
.form-group{display:flex;flex-direction:column;gap:5px;}
label{font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;font-weight:500;}
input,select{background:var(--input-bg);border:1px solid var(--border2);border-radius:10px;color:var(--text);padding:10px 14px;font-size:.88rem;font-family:'Jost',sans-serif;outline:none;transition:border-color .2s,box-shadow .2s,background .3s;}
input:focus,select:focus{border-color:var(--rose);box-shadow:0 0 0 3px rgba(155,37,69,.12);}
input[readonly]{opacity:.6;cursor:default;}
select option{background:var(--surface);color:var(--text);}

/* BUTTONS */
.btn{padding:10px 22px;border-radius:25px;border:none;cursor:pointer;font-size:.85rem;font-family:'Jost',sans-serif;font-weight:600;transition:all .2s;}
.btn-primary{background:linear-gradient(135deg,var(--rose-dark),var(--rose));color:white;box-shadow:0 4px 16px rgba(107,15,42,.40);}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 22px rgba(107,15,42,.52);}
.btn-ghost{background:transparent;color:var(--muted);border:1px solid var(--border2);}
.btn-ghost:hover{color:var(--rose-dark);border-color:var(--rose);}
.btn-danger{background:rgba(110,20,48,.10);color:#9b2545;border:1px solid rgba(110,20,48,.25);font-size:.78rem;padding:6px 12px;}
.btn-danger:hover{background:rgba(110,20,48,.20);}
.btn-edit{background:var(--rose-light);color:var(--rose-dark);border:1px solid rgba(155,37,69,.25);font-size:.78rem;padding:6px 12px;}

/* PILLS */
.pill{display:inline-block;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:600;}
.pill-rose{background:var(--rose-light);color:var(--rose-dark);}
.pill-sage{background:var(--sage-light);color:var(--sage);}
.pill-caramel{background:var(--caramel-light);color:var(--caramel);}
.pill-lavender{background:var(--lavender-light);color:var(--lavender);}
.pill-red{background:rgba(110,20,48,.12);color:#9b2545;}

/* CHARTS */
.bar-chart{display:flex;align-items:flex-end;gap:6px;}
.bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;justify-content:flex-end;height:100%;}
.bar{width:100%;border-radius:6px 6px 0 0;background:linear-gradient(180deg,var(--blush),var(--rose));opacity:.75;transition:opacity .2s;}
.bar:hover{opacity:1;}
.bar-label{font-size:.65rem;color:var(--muted);}
.stock-bar{height:6px;border-radius:3px;background:var(--border);overflow:hidden;margin-top:4px;}
.stock-fill{height:100%;border-radius:3px;}

/* ALERTS */
.alert{padding:12px 16px;border-radius:10px;font-size:.83rem;margin-bottom:12px;border-left:3px solid;}
.alert-warn{background:rgba(155,37,69,.08);border-color:var(--blush);color:var(--blush);}
.alert-danger{background:rgba(155,37,69,.10);border-color:var(--rose);color:var(--rose-dark);}
.alert-success{background:var(--sage-light);border-color:var(--sage);color:var(--sage);}
.info-box{background:var(--lavender-light);border:1px solid rgba(155,37,69,.25);border-radius:12px;padding:14px 18px;font-size:.84rem;color:var(--rose-dark);margin-bottom:20px;display:flex;gap:10px;}

/* PAGES */
.page{display:none;}
.page.active{display:block;animation:fadeUp .3s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* CALCULADORA */
.calc-layout{display:grid;grid-template-columns:1fr 1.2fr;gap:24px;}
.ingredients-list{display:flex;flex-direction:column;gap:8px;max-height:420px;overflow-y:auto;padding-right:4px;}
.ingredient-row{display:flex;align-items:center;gap:10px;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px 14px;transition:all .2s;}
.ingredient-row:hover{border-color:var(--rose);background:var(--rose-light);}
.ing-name{flex:1;font-size:.88rem;font-weight:500;color:var(--text);}
.ing-price{font-size:.74rem;color:var(--muted);}
.ing-qty{width:72px;padding:6px 8px;font-size:.82rem;text-align:center;}
.ing-unit{font-size:.7rem;color:var(--muted);min-width:28px;}
.ing-subtotal{font-size:.85rem;font-weight:700;color:var(--rose-dark);min-width:72px;text-align:right;}
.ing-check{width:17px;height:17px;accent-color:var(--rose);cursor:pointer;flex-shrink:0;}
.recipe-result{background:linear-gradient(135deg,var(--surface2),var(--bg2));border:1px solid var(--border2);border-radius:16px;padding:22px;}
.recipe-name-input{font-family:'Cormorant Garamond',serif;font-size:1.4rem;font-weight:600;border:none;background:transparent;border-bottom:2px solid var(--border2);border-radius:0;width:100%;padding:4px 0;margin-bottom:20px;color:var(--rose-dark);}
.recipe-name-input:focus{outline:none;border-bottom-color:var(--rose);box-shadow:none;}
.result-line{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px dashed var(--border2);font-size:.86rem;}
.result-line:last-child{border-bottom:none;}
.result-line.total{padding-top:14px;font-family:'Cormorant Garamond',serif;font-size:1.05rem;font-weight:700;}
.result-line .label{color:var(--text2);}
.result-line .value{font-weight:600;color:var(--text);}
.result-line.total .value{color:var(--rose-dark);font-size:1.3rem;}
.margin-slider{width:100%;accent-color:var(--rose);cursor:pointer;}
.recipe-grid-saved{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;}
.recipe-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px;box-shadow:var(--shadow);transition:all .2s;}
.recipe-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-hover);}
.recipe-card-name{font-family:'Cormorant Garamond',serif;font-size:1.05rem;font-weight:700;color:var(--rose-dark);margin-bottom:10px;}
.unit-badge{display:inline-block;font-size:.68rem;padding:2px 8px;border-radius:12px;background:var(--caramel-light);color:var(--caramel);font-weight:600;}
.ing-calc-col{color:var(--blush);font-weight:700;font-size:.82rem;}

hr{border:none;border-top:1px solid var(--border);margin:18px 0;}
.result-line .value input{width:80px;text-align:center;padding:4px 8px;font-size:.85rem;}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:var(--modal-backdrop);backdrop-filter:blur(4px);z-index:200;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:30px;width:480px;max-width:90vw;box-shadow:0 20px 60px rgba(0,0,0,.2);}
.modal h3{font-family:'Cormorant Garamond',serif;font-size:1.3rem;margin-bottom:20px;color:var(--rose-dark);}
.modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:20px;}

::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}

.deco{position:fixed;border-radius:50%;pointer-events:none;}
.deco1{width:300px;height:300px;background:var(--rose);top:-100px;right:100px;opacity:.03;}
.deco2{width:200px;height:200px;background:var(--blush);bottom:50px;right:300px;opacity:.03;}

/* SYNC BAR */
.sync-bar{
  position:fixed;bottom:0;left:250px;right:0;
  padding:7px 20px;font-size:.75rem;font-family:'Jost',sans-serif;
  display:flex;align-items:center;gap:8px;
  background:var(--surface);border-top:1px solid var(--border);
  z-index:90;transition:background .3s;
}
.sync-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;transition:background .3s;}
.sync-dot.ok{background:var(--sage);}
.sync-dot.saving{background:var(--caramel);animation:pulse .8s infinite;}
.sync-dot.error{background:var(--rose);}
.sync-dot.loading{background:var(--lavender);animation:pulse .8s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.sync-text{color:var(--muted);}
.sync-time{margin-left:auto;color:var(--muted);opacity:.7;}
@media(max-width:760px){.sync-bar{left:58px;}}

@media(max-width:1100px){
  .kpi-grid{grid-template-columns:repeat(2,1fr);}
  .calc-layout{grid-template-columns:1fr;}
}

/* ====== MOBILE (‚â§ 768px) ====== */
@media(max-width:768px){
  /* Ocultar sidebar lateral completamente */
  .sidebar{display:none;}
  .sync-bar{left:0;bottom:70px;}

  /* Main ocupa todo el ancho */
  .main{margin-left:0;}

  /* Topbar compacto */
  .topbar{padding:10px 14px;gap:8px;}
  .topbar-left h2{font-size:1.15rem;}
  .topbar-date{display:none;}
  .topbar-right{gap:6px;}
  .currency-btn{padding:5px 9px;font-size:.72rem;}
  .theme-toggle{padding:5px 10px;font-size:.75rem;}
  #theme-label{display:none;}
  .tasa-wrap input{width:70px;}

  /* Contenido con padding menor y espacio para nav inferior */
  .content{padding:16px 14px 90px;}

  /* KPI grid 2 columnas */
  .kpi-grid{grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
  .kpi-card{padding:14px;}
  .kpi-emoji{font-size:1.3rem;margin-bottom:6px;}
  .kpi-value{font-size:1.55rem;}
  .kpi-sub{font-size:.68rem;}

  /* Grid 1 columna */
  .grid2{grid-template-columns:1fr;}
  .calc-layout{grid-template-columns:1fr;}

  /* Cards */
  .card{padding:16px;border-radius:14px;}
  .card-title{font-size:1rem;}

  /* Tablas scrolleables horizontalmente */
  .card{overflow-x:auto;}
  table{min-width:480px;font-size:.78rem;}
  th{padding:6px 8px;}
  td{padding:8px 8px;}

  /* Formularios 1 columna */
  .form-row{grid-template-columns:1fr;}

  /* Botones full width en m√≥vil */
  .btn-primary{width:100%;text-align:center;padding:12px;}

  /* KPI: texto m√°s peque√±o para evitar desbordamiento (especialmente VES) */
  .kpi-value{font-size:1.3rem;}

  /* Tasa de cambio: moverla debajo en pantallas muy peque√±as */
  .topbar{flex-wrap:wrap;}
  .tasa-wrap{order:3;width:100%;justify-content:center;padding:4px 0;}
  .tasa-wrap input{width:80px;}

  /* Currency selector m√°s compacto */
  .currency-selector{font-size:.7rem;}
  .currency-btn{padding:4px 7px;font-size:.7rem;}

  /* Theme toggle sin texto en pantallas peque√±as */
  .theme-toggle span:not(.toggle-track){font-size:.72rem;}

  /* Calculadora */
  .ing-qty{width:60px;}
  .ing-subtotal{min-width:55px;font-size:.78rem;}
  .recipe-result{padding:16px;}

  /* MEN√ö INFERIOR M√ìVIL */
  .mobile-nav{
    display:flex;
    position:fixed;bottom:0;left:0;right:0;
    background:var(--surface);
    border-top:1px solid var(--border);
    z-index:100;
    height:70px;
    box-shadow:0 -4px 20px rgba(0,0,0,.08);
  }
  .mobile-nav-item{
    flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
    gap:3px;cursor:pointer;padding:8px 4px;
    font-size:.58rem;color:var(--muted);
    transition:all .2s;border-top:2px solid transparent;
    font-family:'Jost',sans-serif;font-weight:500;
  }
  .mobile-nav-item.active{color:var(--rose-dark);border-top-color:var(--rose);}
  .mobile-nav-item .mn-icon{font-size:1.3rem;line-height:1;}

  /* Alertas m√°s compactas */
  .alert{font-size:.78rem;padding:10px 12px;}
  .info-box{font-size:.78rem;padding:10px 12px;}

  /* Barras de charts m√°s bajas en m√≥vil */
  .bar-chart{gap:3px;}
}

/* ====== Extra peque√±o (‚â§ 400px - iPhone SE, etc.) ====== */
@media(max-width:400px){
  .topbar-right{gap:4px;}
  .currency-btn{padding:4px 5px;font-size:.65rem;}
  .kpi-value{font-size:1.15rem;}
  .kpi-grid{gap:8px;}
  .kpi-card{padding:12px 10px;}
  .content{padding:12px 10px 90px;}
  .card{padding:12px;}
  .mobile-nav-item{font-size:.52rem;}
  .mobile-nav-item .mn-icon{font-size:1.15rem;}
}

/* ====== Desktop: ocultar men√∫ m√≥vil ====== */
@media(min-width:769px){
  .mobile-nav{display:none;}
}
</style>
</head>
<body>
<!-- LOGIN SCREEN -->
<div id="login-screen" style="display:flex;">
  <div class="login-box">
    <div class="login-logo">üéÇ</div>
    <div class="login-title">duni's <em>Cakes</em></div>
    <div class="login-sub">Panel de Gesti√≥n</div>

    <!-- TABS LOGIN/REGISTRO -->
    <div id="login-main-view">
      <div class="login-tabs">
        <button class="login-tab active" onclick="switchTab('login', this)">Iniciar Sesi√≥n</button>
        <button class="login-tab" onclick="switchTab('register', this)">Registrarse</button>
      </div>
      <div class="login-form">
        <input type="email" id="auth-email" placeholder="‚úâÔ∏è  Correo electr√≥nico">
        <input type="password" id="auth-password" placeholder="üîí  Contrase√±a">
        <div id="login-msg" class="login-msg"></div>
        <button class="login-btn" id="auth-btn" onclick="handleAuth()">Iniciar Sesi√≥n</button>
      </div>
      <div style="text-align:center;margin-top:14px;">
        <button onclick="showForgotPassword()" style="background:none;border:none;color:var(--muted);font-size:.8rem;cursor:pointer;font-family:'Jost',sans-serif;text-decoration:underline;">¬øOlvidaste tu contrase√±a?</button>
      </div>
    </div>

    <!-- VISTA RECUPERAR CONTRASE√ëA -->
    <div id="login-forgot-view" style="display:none;">
      <div style="font-size:1.5rem;margin-bottom:8px;">üîë</div>
      <div style="font-weight:600;color:var(--rose-dark);margin-bottom:6px;font-size:1rem;">Recuperar contrase√±a</div>
      <div style="font-size:.82rem;color:var(--muted);margin-bottom:20px;">Te enviaremos un enlace para restablecer tu contrase√±a.</div>
      <div class="login-form">
        <input type="email" id="forgot-email" placeholder="‚úâÔ∏è  Tu correo electr√≥nico">
        <div id="forgot-msg" class="login-msg"></div>
        <button class="login-btn" onclick="handleForgotPassword()">Enviar enlace</button>
      </div>
      <div style="text-align:center;margin-top:14px;">
        <button onclick="showLoginMain()" style="background:none;border:none;color:var(--muted);font-size:.8rem;cursor:pointer;font-family:'Jost',sans-serif;text-decoration:underline;">‚Üê Volver al inicio de sesi√≥n</button>
      </div>
    </div>

    <div id="login-loading" style="font-size:.8rem;color:var(--muted);margin-top:12px;">‚è≥ Conectando con Supabase‚Ä¶</div>
    <div class="login-footer">üîê Tus datos est√°n protegidos con Supabase</div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app-screen" style="display:none;">
<div class="deco deco1"></div><div class="deco deco2"></div>

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="logo">
    <span class="logo-icon">üéÇ</span>
    <h1>duni's <em>Cakes</em></h1>
    <span class="logo-sub">Panel de Gesti√≥n</span>
  </div>
  <div class="nav">
    <div class="nav-section-label">Principal</div>
    <div class="nav-item active" onclick="showPage('dashboard')"><span class="nav-icon">üè†</span><span>Dashboard</span></div>
    <div class="nav-item" onclick="showPage('calculadora')"><span class="nav-icon">üéÇ</span><span>Calculadora de Tortas</span></div>
    <div class="nav-item" onclick="showPage('ingredientes')"><span class="nav-icon">üßà</span><span>Ingredientes y Precios</span></div>
    <div class="nav-section-label">Gesti√≥n</div>
    <div class="nav-item" onclick="showPage('ventas')"><span class="nav-icon">üíµ</span><span>Ventas</span></div>
    <div class="nav-item" onclick="showPage('egresos')"><span class="nav-icon">üì§</span><span>Egresos</span></div>
    <div class="nav-item" onclick="showPage('inventario')"><span class="nav-icon">üì¶</span><span>Inventario</span></div>
    <div class="nav-section-label">Reportes</div>
    <div class="nav-item" onclick="showPage('productos')"><span class="nav-icon">üèÜ</span><span>Tortas M√°s Vendidas</span></div>
    <div class="nav-item" onclick="showPage('utilidades')"><span class="nav-icon">üìà</span><span>Utilidades</span></div>
  </div>
  <div class="sidebar-footer">üéÇ duni's Cakes ¬© 2025</div>
</nav>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h2 id="page-title">Dashboard</h2>
      <div class="topbar-date" id="date-display"></div>
    </div>
    <div class="topbar-right">
      <!-- MONEDA -->
      <div class="currency-selector">
        <button class="currency-btn active" onclick="setCurrency('USD')" id="btn-usd">üá∫üá∏ USD</button>
        <button class="currency-btn" onclick="setCurrency('EUR')" id="btn-eur">üá™üá∫ EUR</button>
        <button class="currency-btn" onclick="setCurrency('VES')" id="btn-ves">üáªüá™ VES</button>
      </div>
      <!-- TASA -->
      <div class="tasa-wrap" id="tasa-wrap" style="display:none">
        <span>1 USD =</span>
        <input type="number" id="tasa-input" min="0.01" step="0.01" oninput="actualizarTasa()">
        <span id="tasa-cur-label">EUR</span>
      </div>
      <!-- MODO CLARO/OSCURO -->
      <button class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-icon">üåô</span>
        <div class="toggle-track"><div class="toggle-thumb"></div></div>
        <span id="theme-label">Oscuro</span>
      </button>
      <!-- LOGOUT -->
      <button class="theme-toggle" onclick="logout()" style="border-color:rgba(155,37,69,.3);">
        üö™ <span>Salir</span>
      </button>
    </div>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page active">
      <div class="kpi-grid">
        <div class="kpi-card rose"><span class="kpi-emoji">üí∞</span><div class="kpi-label">Ventas del Mes</div><div class="kpi-value rose" id="kpi-ventas">‚Äî</div><div class="kpi-sub" id="kpi-ventas-sub"></div></div>
        <div class="kpi-card sage"><span class="kpi-emoji">‚ú®</span><div class="kpi-label">Utilidad Neta</div><div class="kpi-value sage" id="kpi-utilidad">‚Äî</div><div class="kpi-sub" id="kpi-margen-sub"></div></div>
        <div class="kpi-card caramel"><span class="kpi-emoji">üì§</span><div class="kpi-label">Egresos del Mes</div><div class="kpi-value caramel" id="kpi-egresos">‚Äî</div><div class="kpi-sub">Costos + Gastos</div></div>
        <div class="kpi-card lavender"><span class="kpi-emoji">üéÇ</span><div class="kpi-label">Tortas Vendidas</div><div class="kpi-value lavender" id="kpi-tortas">0</div><div class="kpi-sub" id="kpi-ticket"></div></div>
      </div>
      <div class="grid2">
        <div class="card"><div class="card-title">Ventas Recientes <span class="badge">14 d√≠as</span></div><div class="bar-chart" style="height:110px" id="bar-dashboard"></div></div>
        <div class="card"><div class="card-title">Resumen Financiero</div><div id="resumen-dashboard"></div></div>
      </div>
      <div class="card"><div class="card-title">√öltimas Ventas</div>
        <table><thead><tr><th>Producto</th><th>Cant.</th><th>Precio</th><th>Total</th><th>Fecha</th></tr></thead>
        <tbody id="tabla-ult-ventas"></tbody></table></div>
    </div>

    <!-- CALCULADORA -->
    <div id="page-calculadora" class="page">
      <div class="info-box">üí° <span>Marca los ingredientes, ingresa la cantidad exacta que usas (en gramos, ml o unidades) y la calculadora calcula el costo en tiempo real. Ajusta el margen para obtener el precio de venta.</span></div>
      <div class="calc-layout">
        <div>
          <div class="card card-mb">
            <div class="card-title">Selecciona Ingredientes</div>
            <input type="text" id="calc-search" placeholder="üîç Buscar ingrediente..." oninput="renderCalculadora()" style="width:100%;margin-bottom:12px">
            <div class="ingredients-list" id="ingredients-calc-list"></div>
          </div>
        </div>
        <div class="recipe-result">
          <input class="recipe-name-input" id="recipe-name" placeholder="Nombre de la torta...">
          <div style="margin-bottom:14px">
            <div style="font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">Ingredientes seleccionados</div>
            <div id="selected-ingredients-list" style="font-size:.84rem;color:var(--text2);min-height:40px"></div>
          </div>
          <hr>
          <div class="result-line"><span class="label">Costo de ingredientes</span><span class="value" id="calc-costo-ing">‚Äî</span></div>
          <div class="result-line"><span class="label">Costos adicionales (empaque, gas‚Ä¶)</span><span class="value"><input type="number" id="calc-extra" value="0" step="0.5" min="0" oninput="calcularPrecio()"></span></div>
          <div class="result-line"><span class="label">Costo Total</span><span class="value" id="calc-costo-total">‚Äî</span></div>
          <div style="margin-top:18px">
            <div style="display:flex;justify-content:space-between;font-size:.78rem;margin-bottom:8px">
              <span style="color:var(--muted)">Margen de ganancia</span>
              <span style="font-weight:700;color:var(--rose-dark)" id="margen-label">50%</span>
            </div>
            <input type="range" class="margin-slider" id="margin-slider" min="10" max="300" value="50" oninput="calcularPrecio()">
          </div>
          <hr>
          <div class="result-line total"><span class="label">üí∞ Precio de Venta Sugerido</span><span class="value" id="calc-precio-venta">‚Äî</span></div>
          <div class="result-line"><span class="label" style="font-size:.8rem">Ganancia estimada</span><span style="font-size:.88rem;font-weight:600;color:var(--sage)" id="calc-ganancia">‚Äî</span></div>
          <div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="guardarReceta()">üíæ Guardar Receta</button>
            <button class="btn btn-ghost" onclick="limpiarCalculadora()">‚úï Limpiar</button>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top:24px">
        <div class="card-title">Recetas Guardadas <span class="badge" id="recetas-count">0</span></div>
        <div class="recipe-grid-saved" id="recetas-guardadas"></div>
      </div>
    </div>

    <!-- INGREDIENTES -->
    <div id="page-ingredientes" class="page">
      <div class="alert alert-warn">üáªüá™ <strong>Inflaci√≥n Venezuela:</strong> Ingresa el precio del empaque (ej: precio del kilo) y el sistema calcula autom√°ticamente el precio por gramo / ml / unidad. Actualiza el precio cuando cambie con el bot√≥n ‚úèÔ∏è.</div>
      <div class="card card-mb">
        <div class="card-title">Agregar Nuevo Ingrediente</div>
        <div class="form-row">
          <div class="form-group"><label>Nombre del Ingrediente</label><input type="text" id="ing-nombre" placeholder="Ej: Harina de trigo"></div>
          <div class="form-group">
            <label>Presentaci√≥n de Compra</label>
            <select id="ing-unidad-base" onchange="actualizarLabelPrecio()">
              <option value="kg">Por Kilogramo (kg)</option>
              <option value="litro">Por Litro (L)</option>
              <option value="docena">Por Docena (12 und.)</option>
              <option value="unidad">Por Unidad</option>
            </select>
          </div>
          <div class="form-group">
            <label id="ing-precio-label">Precio por kg (USD)</label>
            <input type="number" id="ing-precio-base" placeholder="Ej: 2.00" step="0.01" min="0" oninput="mostrarPrevioIngrediente()">
          </div>
          <div class="form-group">
            <label>Categor√≠a</label>
            <select id="ing-cat">
              <option>Harinas y Polvos</option><option>L√°cteos</option><option>Huevos</option>
              <option>Endulzantes</option><option>Grasas y Aceites</option>
              <option>Saborizantes</option><option>Decoraci√≥n</option><option>Empaque</option><option>Otros</option>
            </select>
          </div>
        </div>
        <div id="ing-calc-preview" style="display:none;margin-bottom:16px">
          <div class="alert alert-success" id="ing-calc-text" style="margin-bottom:0"></div>
        </div>
        <button class="btn btn-primary" onclick="agregarIngrediente()">+ Agregar Ingrediente</button>
      </div>
      <div class="card">
        <div class="card-title">Mis Ingredientes <span class="badge" id="ing-count">0</span></div>
        <table>
          <thead><tr><th>Ingrediente</th><th>Categor√≠a</th><th>Precio de Compra</th><th>‚ö° Precio por Uso</th><th>√öltima Actualizaci√≥n</th><th>Acciones</th></tr></thead>
          <tbody id="tabla-ingredientes"></tbody>
        </table>
      </div>
    </div>

    <!-- VENTAS -->
    <div id="page-ventas" class="page">
      <div class="card card-mb">
        <div class="card-title">Registrar Nueva Venta</div>
        <div class="form-row">
          <div class="form-group"><label>Producto / Torta</label><input type="text" id="venta-prod" placeholder="Ej: Torta de Chocolate"></div>
          <div class="form-group"><label>Cantidad</label><input type="number" id="venta-cant" value="1" min="1"></div>
          <div class="form-group"><label>Precio de Venta (USD)</label><input type="number" id="venta-precio" placeholder="0.00" step="0.50"></div>
          <div class="form-group"><label>Costo de Producci√≥n (USD)</label><input type="number" id="venta-costo" placeholder="0.00" step="0.50"></div>
          <div class="form-group"><label>Fecha</label><input type="date" id="venta-fecha"></div>
        </div>
        <div style="display:flex;gap:12px;align-items:center">
          <button class="btn btn-primary" onclick="agregarVenta()">+ Registrar Venta</button>
          <span id="venta-preview" style="font-size:.85rem;color:var(--sage);font-weight:500"></span>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Historial de Ventas <span class="badge" id="ventas-count-badge">0</span></div>
        <table><thead><tr><th>Producto</th><th>Cant.</th><th>Precio</th><th>Costo</th><th>Ganancia</th><th>Total</th><th>Fecha</th><th></th></tr></thead>
        <tbody id="tabla-ventas"></tbody></table>
      </div>
    </div>

    <!-- EGRESOS -->
    <div id="page-egresos" class="page">
      <div class="card card-mb">
        <div class="card-title">Registrar Egreso</div>
        <div class="form-row">
          <div class="form-group"><label>Concepto</label><input type="text" id="egr-concepto" placeholder="Ej: Compra de harina"></div>
          <div class="form-group"><label>Categor√≠a</label>
            <select id="egr-cat"><option>Ingredientes</option><option>Empaque</option><option>Servicios (luz, gas)</option><option>Transporte</option><option>Marketing</option><option>Equipos</option><option>Otros</option></select>
          </div>
          <div class="form-group"><label>Monto (USD)</label><input type="number" id="egr-monto" placeholder="0.00" step="0.50"></div>
          <div class="form-group"><label>Fecha</label><input type="date" id="egr-fecha"></div>
        </div>
        <button class="btn btn-primary" onclick="agregarEgreso()">+ Registrar Egreso</button>
      </div>
      <div class="grid2">
        <div class="card"><div class="card-title">Por Categor√≠a</div><div id="egresos-por-cat"></div></div>
        <div class="card"><div class="card-title">Historial</div>
          <table><thead><tr><th>Concepto</th><th>Cat.</th><th>Monto</th><th>Fecha</th><th></th></tr></thead>
          <tbody id="tabla-egresos"></tbody></table></div>
      </div>
    </div>

    <!-- INVENTARIO -->
    <div id="page-inventario" class="page">
      <div id="inv-alertas"></div>
      <div class="card card-mb">
        <div class="card-title">Agregar Insumo</div>
        <div class="form-row">
          <div class="form-group"><label>Insumo</label><input type="text" id="inv-nombre" placeholder="Ej: Mantequilla"></div>
          <div class="form-group"><label>Unidad</label><select id="inv-unidad"><option>kg</option><option>litros</option><option>gramos</option><option>unidades</option><option>cajas</option></select></div>
          <div class="form-group"><label>Stock Actual</label><input type="number" id="inv-stock" placeholder="0"></div>
          <div class="form-group"><label>Stock M√≠nimo</label><input type="number" id="inv-min" placeholder="0"></div>
          <div class="form-group"><label>Costo/Unidad (USD)</label><input type="number" id="inv-costo" placeholder="0.00" step="0.01"></div>
        </div>
        <button class="btn btn-primary" onclick="agregarInventario()">+ Agregar Insumo</button>
      </div>
      <div class="card">
        <div class="card-title">Control de Inventario</div>
        <table><thead><tr><th>Insumo</th><th>Stock</th><th>M√≠nimo</th><th>Costo Unit.</th><th>Valor Total</th><th>Nivel</th><th></th></tr></thead>
        <tbody id="tabla-inventario"></tbody></table>
      </div>
    </div>

    <!-- TOP TORTAS -->
    <div id="page-productos" class="page">
      <div class="grid2" style="margin-bottom:20px">
        <div class="card"><div class="card-title">üèÜ Tortas M√°s Vendidas</div>
          <table><thead><tr><th>Pos.</th><th>Torta</th><th>Unidades</th><th>Ingresos</th></tr></thead>
          <tbody id="tabla-top-ventas"></tbody></table></div>
        <div class="card"><div class="card-title">üíö Mayor Rentabilidad</div>
          <table><thead><tr><th>Torta</th><th>Precio</th><th>Costo</th><th>Margen</th></tr></thead>
          <tbody id="tabla-top-margen"></tbody></table></div>
      </div>
      <div class="card"><div class="card-title">Ventas por Torta</div><div class="bar-chart" style="height:130px" id="bar-top-tortas"></div></div>
    </div>

    <!-- UTILIDADES -->
    <div id="page-utilidades" class="page">
      <div class="kpi-grid" style="margin-bottom:20px">
        <div class="kpi-card rose"><span class="kpi-emoji">üíµ</span><div class="kpi-label">Ingresos Totales</div><div class="kpi-value rose" id="util-ingresos">‚Äî</div></div>
        <div class="kpi-card caramel"><span class="kpi-emoji">üí∏</span><div class="kpi-label">Egresos Totales</div><div class="kpi-value caramel" id="util-egresos">‚Äî</div></div>
        <div class="kpi-card sage"><span class="kpi-emoji">üå∏</span><div class="kpi-label">Utilidad Neta</div><div class="kpi-value sage" id="util-neta">‚Äî</div></div>
        <div class="kpi-card lavender"><span class="kpi-emoji">üìä</span><div class="kpi-label">Margen Neto</div><div class="kpi-value lavender" id="util-margen">0%</div></div>
      </div>
      <div class="grid2">
        <div class="card"><div class="card-title">Estado de Resultados</div><table><tbody id="tabla-resultados"></tbody></table></div>
        <div class="card"><div class="card-title">Tendencia de Ventas</div><div class="bar-chart" style="height:140px" id="bar-utilidades"></div></div>
      </div>
    </div>

  </div>
</div>

<!-- MEN√ö INFERIOR M√ìVIL -->
<nav class="mobile-nav" id="mobile-nav">
  <div class="mobile-nav-item active" onclick="showPage('dashboard')" id="mn-dashboard">
    <span class="mn-icon">üè†</span><span>Inicio</span>
  </div>
  <div class="mobile-nav-item" onclick="showPage('calculadora')" id="mn-calculadora">
    <span class="mn-icon">üéÇ</span><span>Calcular</span>
  </div>
  <div class="mobile-nav-item" onclick="showPage('ingredientes')" id="mn-ingredientes">
    <span class="mn-icon">üßà</span><span>Ingredientes</span>
  </div>
  <div class="mobile-nav-item" onclick="showPage('ventas')" id="mn-ventas">
    <span class="mn-icon">üíµ</span><span>Ventas</span>
  </div>
  <div class="mobile-nav-item" onclick="showMobileMore()" id="mn-more">
    <span class="mn-icon">‚ò∞</span><span>M√°s</span>
  </div>
</nav>

<!-- MEN√ö "M√ÅS" M√ìVIL -->
<div id="mobile-more-overlay" style="display:none;position:fixed;inset:0;background:var(--modal-backdrop);z-index:150" onclick="hideMobileMore()"></div>
<div id="mobile-more-sheet" style="display:none;position:fixed;bottom:70px;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);border-radius:20px 20px 0 0;z-index:160;padding:16px 0 8px;">
  <div style="text-align:center;font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">M√°s opciones</div>
  <div onclick="showPage('egresos');hideMobileMore()" style="display:flex;align-items:center;gap:14px;padding:13px 24px;cursor:pointer;font-size:.9rem;color:var(--text2)"><span style="font-size:1.2rem">üì§</span> Egresos</div>
  <div onclick="showPage('inventario');hideMobileMore()" style="display:flex;align-items:center;gap:14px;padding:13px 24px;cursor:pointer;font-size:.9rem;color:var(--text2)"><span style="font-size:1.2rem">üì¶</span> Inventario</div>
  <div onclick="showPage('productos');hideMobileMore()" style="display:flex;align-items:center;gap:14px;padding:13px 24px;cursor:pointer;font-size:.9rem;color:var(--text2)"><span style="font-size:1.2rem">üèÜ</span> Tortas M√°s Vendidas</div>
  <div onclick="showPage('utilidades');hideMobileMore()" style="display:flex;align-items:center;gap:14px;padding:13px 24px;cursor:pointer;font-size:.9rem;color:var(--text2)"><span style="font-size:1.2rem">üìà</span> Utilidades</div>
  <div style="height:1px;background:var(--border);margin:8px 24px"></div>
  <div onclick="logout();hideMobileMore()" style="display:flex;align-items:center;gap:14px;padding:13px 24px;cursor:pointer;font-size:.9rem;color:var(--rose-dark);font-weight:600"><span style="font-size:1.2rem">üö™</span> Cerrar Sesion</div>
  <div style="height:8px"></div>
</div>

<!-- SYNC STATUS BAR -->
<div class="sync-bar" id="sync-bar">
  <div class="sync-dot loading" id="sync-dot"></div>
  <span class="sync-text" id="sync-text">Conectando con la nube‚Ä¶</span>
  <span class="sync-time" id="sync-time"></span>
</div>

<!-- MODAL EDITAR PRECIO -->
<div class="modal-overlay" id="modal-edit-ing">
  <div class="modal">
    <h3>‚úèÔ∏è Actualizar Precio de Ingrediente</h3>
    <input type="hidden" id="edit-ing-id">
    <div class="form-group" style="margin-bottom:14px">
      <label>Ingrediente</label><input type="text" id="edit-ing-nombre" readonly>
    </div>
    <div class="alert alert-warn" style="margin-bottom:14px;font-size:.8rem">
      üáªüá™ Actualiza el precio cuando suba por inflaci√≥n. El c√°lculo por gramo/ml/unidad se recalcular√° autom√°ticamente.
    </div>
    <div class="form-row">
      <div class="form-group"><label>Precio Anterior</label><input type="text" id="edit-ing-precio-old" readonly></div>
      <div class="form-group"><label id="edit-ing-precio-label">Nuevo Precio (USD)</label><input type="number" id="edit-ing-precio-new" step="0.01" min="0" placeholder="0.00"></div>
    </div>
    <div id="edit-calc-preview" style="font-size:.82rem;color:var(--sage);margin-top:8px;font-weight:600"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarPrecioIngrediente()">üíæ Guardar Precio</button>
    </div>
  </div>
</div>

<script>
// ========== SUPABASE CONFIG ==========
const SUPABASE_URL = 'https://cwojwwsvbszooexvidlb.supabase.co';
const SUPABASE_KEY = 'sb_publishable_ZwDAlPX67qjIEHuiGzfmFA_trmBV7Kh';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
  auth: {
    storage: window.localStorage,
    storageKey: 'duniscakes-auth',
    flowType: 'implicit',
    detectSessionInUrl: true,
    persistSession: true,
    autoRefreshToken: true,
  }
});

let currentUser = null;
let currentTab = 'login';

// ========== AUTH UI ==========
function switchTab(tab, el) {
  currentTab = tab;
  document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('auth-btn').textContent = tab === 'login' ? 'Iniciar Sesion' : 'Registrarse';
  document.getElementById('login-msg').className = 'login-msg';
  document.getElementById('login-msg').textContent = '';
}

function showLoginMsg(msg, type) {
  const el = document.getElementById('login-msg');
  el.textContent = msg;
  el.className = 'login-msg ' + type;
}

async function handleAuth() {
  const email = document.getElementById('auth-email').value.trim();
  const password = document.getElementById('auth-password').value;
  const btn = document.getElementById('auth-btn');
  if (!email || !password) return showLoginMsg('Por favor completa todos los campos.', 'error');
  btn.disabled = true;
  btn.textContent = 'Cargando...';
  try {
    let result;
    if (currentTab === 'login') {
      result = await sb.auth.signInWithPassword({ email, password });
    } else {
      result = await sb.auth.signUp({ email, password });
      if (!result.error && result.data.user && !result.data.session) {
        showLoginMsg('‚úÖ Registro exitoso. Revisa tu correo para confirmar tu cuenta.', 'success');
        btn.disabled = false; btn.textContent = 'Registrarse'; return;
      }
    }
    if (result.error) {
      const msgs = {
        'Invalid login credentials': 'Correo o contrasena incorrectos.',
        'User already registered': 'Este correo ya esta registrado.',
        'Password should be at least 6 characters': 'La contrasena debe tener al menos 6 caracteres.',
      };
      showLoginMsg(msgs[result.error.message] || result.error.message, 'error');
    }
  } catch(e) {
    showLoginMsg('Error de conexion. Intenta de nuevo.', 'error');
  }
  btn.disabled = false;
  btn.textContent = currentTab === 'login' ? 'Iniciar Sesion' : 'Registrarse';
}

async function logout() {
  await sb.auth.signOut();
  currentUser = null;
  resetState();
  // Clear id maps
  Object.keys(idMap).forEach(k => idMap[k] = {});
  document.getElementById('app-screen').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
}

function showForgotPassword() {
  document.getElementById('login-main-view').style.display = 'none';
  document.getElementById('login-forgot-view').style.display = 'block';
  document.getElementById('forgot-msg').className = 'login-msg';
  document.getElementById('forgot-msg').textContent = '';
  const emailVal = document.getElementById('auth-email').value || '';
  document.getElementById('forgot-email').value = emailVal;
}

function showLoginMain() {
  document.getElementById('login-forgot-view').style.display = 'none';
  document.getElementById('login-main-view').style.display = 'block';
}

async function handleForgotPassword() {
  const email = document.getElementById('forgot-email').value.trim();
  const msgEl = document.getElementById('forgot-msg');
  if (!email) {
    msgEl.textContent = 'Por favor escribe tu correo.';
    msgEl.className = 'login-msg error';
    return;
  }
  msgEl.textContent = 'Enviando...';
  msgEl.className = 'login-msg';
  msgEl.style.display = 'block';
  try {
    const { error } = await sb.auth.resetPasswordForEmail(email, {
      redirectTo: 'https://duniscakes.store'
    });
    if (error) throw error;
    msgEl.textContent = 'Enlace enviado. Revisa tu correo y haz clic en el enlace para restablecer tu contrasena.';
    msgEl.className = 'login-msg success';
  } catch(e) {
    msgEl.textContent = 'Error al enviar. Verifica el correo e intenta de nuevo.';
    msgEl.className = 'login-msg error';
  }
}

// ========== SYNC STATUS ==========
let syncTimeout = null;
let lastSaved = null;

function setSyncStatus(status, msg) {
  const dot  = document.getElementById('sync-dot');
  const text = document.getElementById('sync-text');
  const time = document.getElementById('sync-time');
  dot.className  = 'sync-dot ' + status;
  text.textContent = msg;
  if (lastSaved && status === 'ok') {
    time.textContent = '√öltimo guardado: ' + lastSaved.toLocaleTimeString('es-VE');
  } else { time.textContent = ''; }
}

function scheduleSave() {
  if (syncTimeout) clearTimeout(syncTimeout);
  setSyncStatus('saving', 'Guardando en Supabase...');
  syncTimeout = setTimeout(saveAll, 1500);
}

// ========== SUPABASE CRUD ==========
async function saveAll() {
  if (!currentUser) return;
  setSyncStatus('saving', 'Guardando en Supabase...');
  try {
    await saveTable('ingredientes', state.ingredientes.map(i => ({
      _localId: i.id,
      user_id: currentUser.id,
      nombre: i.nombre, unidad_base: i.unidadBase,
      precio_base: i.precioBase, precio: i.precio,
      cat: i.cat, updated: i.updated
    })));
    await saveTable('ventas', state.ventas.map(v => ({
      _localId: v.id,
      user_id: currentUser.id,
      producto: v.producto, cantidad: v.cantidad,
      precio: v.precio, costo: v.costo, fecha: v.fecha
    })));
    await saveTable('egresos', state.egresos.map(e => ({
      _localId: e.id,
      user_id: currentUser.id,
      concepto: e.concepto, cat: e.cat, monto: e.monto, fecha: e.fecha
    })));
    await saveTable('inventario', state.inventario.map(i => ({
      _localId: i.id,
      user_id: currentUser.id,
      nombre: i.nombre, unidad: i.unidad,
      stock: i.stock, min: i.min, costo: i.costo
    })));
    await saveRecetas();
    lastSaved = new Date();
    setSyncStatus('ok', 'Guardado en Supabase - sincronizado en todos tus dispositivos');
  } catch(e) {
    setSyncStatus('error', 'Error al guardar: ' + e.message);
    console.error('Save error:', e);
  }
}

// Map localId -> dbId para no insertar duplicados
const idMap = { ingredientes:{}, ventas:{}, egresos:{}, inventario:{}, recetas:{} };

async function saveTable(table, rows) {
  if (!rows.length) return;
  // Upsert simple ‚Äî si tiene id de Supabase actualiza, si no inserta
  const toInsert = [];
  const toUpdate = [];
  for (const row of rows) {
    const localId = row._localId;
    delete row._localId;
    const dbId = idMap[table][localId];
    if (dbId) {
      row.id = dbId;
      toUpdate.push(row);
    } else {
      toInsert.push({ row, localId });
    }
  }
  // Actualizar existentes
  if (toUpdate.length) {
    const { error } = await sb.from(table).upsert(toUpdate, { onConflict: 'id' });
    if (error) throw error;
  }
  // Insertar nuevos uno por uno para obtener el id
  for (const { row, localId } of toInsert) {
    const { data, error } = await sb.from(table).insert(row).select('id').single();
    if (error) throw error;
    if (data) {
      idMap[table][localId] = data.id;
      // Actualizar el id local en state para futuras operaciones
      const stateMap = {
        ingredientes: state.ingredientes,
        ventas: state.ventas,
        egresos: state.egresos,
        inventario: state.inventario,
      };
      const arr = stateMap[table];
      if (arr) {
        const item = arr.find(x => x.id === localId);
        if (item) item.id = data.id;
      }
    }
  }
}

async function saveRecetas() {
  for (const r of state.recetas) {
    const row = {
      user_id: currentUser.id,
      nombre: r.nombre,
      ingredientes: r.ingredientes,
      costo_total: r.costoTotal,
      precio_venta: r.precioVenta,
      margen: r.margen
    };
    const dbId = idMap['recetas'][r.id];
    if (dbId) {
      row.id = dbId;
      const { error } = await sb.from('recetas').upsert(row, { onConflict: 'id' });
      if (error) throw error;
    } else {
      const { data, error } = await sb.from('recetas').insert(row).select('id').single();
      if (error) throw error;
      if (data) idMap['recetas'][r.id] = data.id;
    }
  }
}

async function loadAll() {
  if (!currentUser) return;
  setSyncStatus('loading', 'Cargando tus datos desde Supabase...');
  try {
    const uid = currentUser.id;
    const [ing, ven, egr, inv, rec] = await Promise.all([
      sb.from('ingredientes').select('*').eq('user_id', uid),
      sb.from('ventas').select('*').eq('user_id', uid),
      sb.from('egresos').select('*').eq('user_id', uid),
      sb.from('inventario').select('*').eq('user_id', uid),
      sb.from('recetas').select('*').eq('user_id', uid),
    ]);
    if (ing.data && ing.data.length) {
      state.ingredientes = ing.data.map(i => {
        idMap['ingredientes'][i.id] = i.id;
        const precioBase = parseFloat(i.precio_base) || 0;
        const unidadBase = i.unidad_base;
        return { id: i.id, nombre: i.nombre, unidadBase,
          precioBase, precio: calcPxU(precioBase, unidadBase),
          cat: i.cat, updated: i.updated };
      });
    }
    if (ven.data && ven.data.length) {
      state.ventas = ven.data.map(v => {
        idMap['ventas'][v.id] = v.id;
        return { id: v.id, producto: v.producto, cantidad: v.cantidad,
          precio: parseFloat(v.precio), costo: parseFloat(v.costo), fecha: v.fecha };
      });
    }
    if (egr.data && egr.data.length) {
      state.egresos = egr.data.map(e => {
        idMap['egresos'][e.id] = e.id;
        return { id: e.id, concepto: e.concepto, cat: e.cat,
          monto: parseFloat(e.monto), fecha: e.fecha };
      });
    }
    if (inv.data && inv.data.length) {
      state.inventario = inv.data.map(i => {
        idMap['inventario'][i.id] = i.id;
        return { id: i.id, nombre: i.nombre, unidad: i.unidad,
          stock: parseFloat(i.stock), min: parseFloat(i.min), costo: parseFloat(i.costo) };
      });
    }
    if (rec.data && rec.data.length) {
      state.recetas = rec.data.map(r => {
        idMap['recetas'][r.id] = r.id;
        return { id: r.id, nombre: r.nombre, ingredientes: r.ingredientes,
          costoTotal: parseFloat(r.costo_total), precioVenta: parseFloat(r.precio_venta),
          margen: r.margen };
      });
    }
    // nextId mayor que cualquier id existente para evitar conflictos
    const allIds = [
      ...state.ingredientes, ...state.ventas, ...state.egresos,
      ...state.inventario, ...state.recetas
    ].map(x => typeof x.id === 'number' ? x.id : 0);
    if (allIds.length) nextId = Math.max(...allIds) + 1;
    setSyncStatus('ok', 'Datos cargados - sincronizado en todos tus dispositivos');
  } catch(e) {
    setSyncStatus('error', 'Error al cargar datos: ' + e.message);
    console.error('Load error:', e);
  }
  render();
}

async function deleteFromDb(table, localId) {
  if (!currentUser) return;
  const dbId = idMap[table][localId] || localId;
  await sb.from(table).delete().eq('id', dbId).eq('user_id', currentUser.id);
  delete idMap[table][localId];
}

// ========== CURRENCY ==========
let currentCurrency = 'USD';
let tasas = { EUR: 0.92, VES: 40.5 };
const currencyConfig = {
  USD: { symbol:'$',   dec:2 },
  EUR: { symbol:'‚Ç¨',   dec:2 },
  VES: { symbol:'Bs.', dec:0 },
};
function fmt(usd) {
  const cfg = currencyConfig[currentCurrency];
  let v = usd;
  if (currentCurrency==='EUR') v = usd * tasas.EUR;
  if (currentCurrency==='VES') v = usd * tasas.VES;
  return cfg.symbol + v.toLocaleString('es-VE',{minimumFractionDigits:cfg.dec,maximumFractionDigits:cfg.dec});
}
function setCurrency(cur) {
  currentCurrency = cur;
  ['USD','EUR','VES'].forEach(c => document.getElementById('btn-'+c.toLowerCase()).classList.remove('active'));
  document.getElementById('btn-'+cur.toLowerCase()).classList.add('active');
  const wrap = document.getElementById('tasa-wrap');
  const inp  = document.getElementById('tasa-input');
  const lbl  = document.getElementById('tasa-cur-label');
  if (cur==='USD') { wrap.style.display='none'; }
  else { wrap.style.display='flex'; inp.value = tasas[cur]; lbl.textContent = cur; }
  render();
}
function actualizarTasa() {
  const v = parseFloat(document.getElementById('tasa-input').value);
  if (!isNaN(v) && v>0) { tasas[currentCurrency] = v; render(); }
}

// ========== DARK MODE ==========
function toggleTheme() {
  const html = document.documentElement;
  const dark = html.getAttribute('data-theme')==='dark';
  html.setAttribute('data-theme', dark ? 'light' : 'dark');
  document.getElementById('theme-icon').textContent  = dark ? 'üåô' : '‚òÄÔ∏è';
  document.getElementById('theme-label').textContent = dark ? 'Oscuro' : 'Claro';
}

// ========== HELPERS ==========
const pct = n => parseFloat(n||0).toFixed(1)+'%';
function calcPxU(precioBase, unidadBase) {
  if (unidadBase==='kg')     return precioBase/1000;
  if (unidadBase==='litro')  return precioBase/1000;
  if (unidadBase==='docena') return precioBase/12;
  return precioBase;
}
function unidadMin(base) { return {kg:'gramo',litro:'ml',docena:'unidad',unidad:'unidad'}[base]||'unidad'; }
function labelBase(base) { return {kg:'kg',litro:'litro',docena:'docena',unidad:'unidad'}[base]||base; }

// ========== STATE ==========
function resetState() {
  state = { ingredientes:[], ventas:[], egresos:[], inventario:[], recetas:[] };
  nextId = 500;
}
let state = { ingredientes:[], ventas:[], egresos:[], inventario:[], recetas:[] };
let nextId = 500;

function afterMutation() { render(); scheduleSave(); }

// ========== NAV ==========
const pageTitles={dashboard:'Dashboard',calculadora:'üéÇ Calculadora de Tortas',ingredientes:'üßà Ingredientes y Precios',ventas:'üíµ Ventas',egresos:'üì§ Egresos',inventario:'üì¶ Inventario',productos:'üèÜ Tortas M√°s Vendidas',utilidades:'üìà Utilidades'};
const mobileNavPages=['dashboard','calculadora','ingredientes','ventas'];

function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  const idx={dashboard:0,calculadora:1,ingredientes:2,ventas:3,egresos:4,inventario:5,productos:6,utilidades:7};
  document.querySelectorAll('.nav-item')[idx[name]].classList.add('active');
  document.getElementById('page-title').textContent=pageTitles[name];
  document.querySelectorAll('.mobile-nav-item').forEach(i=>i.classList.remove('active'));
  if(mobileNavPages.includes(name)){
    const mn=document.getElementById('mn-'+name);
    if(mn) mn.classList.add('active');
  } else { document.getElementById('mn-more').classList.add('active'); }
  render();
}
function showMobileMore(){
  document.getElementById('mobile-more-overlay').style.display='block';
  document.getElementById('mobile-more-sheet').style.display='block';
}
function hideMobileMore(){
  document.getElementById('mobile-more-overlay').style.display='none';
  document.getElementById('mobile-more-sheet').style.display='none';
}
function initDate(){
  const d=new Date();
  document.getElementById('date-display').textContent=d.toLocaleDateString('es-VE',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  document.getElementById('venta-fecha').valueAsDate=d;
  document.getElementById('egr-fecha').valueAsDate=d;
}

// ========== RENDER ALL ==========
function render(){
  renderDashboard(); renderIngredientes(); renderCalculadora();
  renderVentas(); renderEgresos(); renderInventario();
  renderTopProductos(); renderUtilidades(); renderRecetas();
}

function calcKpis(){
  const now=new Date(); const m=now.getMonth(),y=now.getFullYear();
  const vm=state.ventas.filter(v=>{const d=new Date(v.fecha);return d.getMonth()===m&&d.getFullYear()===y;});
  const tv=vm.reduce((s,v)=>s+v.precio*v.cantidad,0);
  const te=state.egresos.reduce((s,e)=>s+e.monto,0);
  const tor=vm.reduce((s,v)=>s+v.cantidad,0);
  return{tv,te,util:tv-te,tor,ticket:vm.length?tv/vm.length:0,vm};
}

function renderDashboard(){
  const k=calcKpis();
  document.getElementById('kpi-ventas').textContent=fmt(k.tv);
  document.getElementById('kpi-ventas-sub').textContent=k.vm.length+' pedidos este mes';
  document.getElementById('kpi-utilidad').textContent=fmt(k.util);
  document.getElementById('kpi-margen-sub').textContent='Margen: '+pct(k.tv?(k.util/k.tv*100):0);
  document.getElementById('kpi-egresos').textContent=fmt(k.te);
  document.getElementById('kpi-tortas').textContent=k.tor;
  document.getElementById('kpi-ticket').textContent='Ticket prom: '+fmt(k.ticket);

  const dias={};
  const hoy=new Date();
  for(let i=13;i>=0;i--){const d=new Date(hoy);d.setDate(d.getDate()-i);dias[d.toISOString().split('T')[0]]=0;}
  state.ventas.forEach(v=>{if(dias[v.fecha]!==undefined)dias[v.fecha]+=v.precio*v.cantidad;});
  const vals=Object.entries(dias); const maxV=Math.max(...vals.map(v=>v[1]),.01);
  const pal=['var(--rose)','var(--blush)','var(--sage)','var(--lavender)','var(--caramel)'];
  document.getElementById('bar-dashboard').innerHTML=vals.map(([d,v],i)=>`
    <div class="bar-wrap"><div class="bar" style="height:${(v/maxV*100).toFixed(0)}%;background:${pal[i%5]}" title="${fmt(v)}"></div><div class="bar-label">${new Date(d).getDate()}</div></div>`).join('');

  const cv=state.ventas.reduce((s,v)=>s+v.costo*v.cantidad,0);
  document.getElementById('resumen-dashboard').innerHTML=`
    <div class="result-line"><span class="label">Ingresos por ventas</span><span style="font-weight:600;color:var(--rose-dark)">${fmt(k.tv)}</span></div>
    <div class="result-line"><span class="label">Costo de producci√≥n</span><span style="color:var(--caramel)">${fmt(cv)}</span></div>
    <div class="result-line"><span class="label">Utilidad bruta</span><span style="font-weight:600;color:var(--sage)">${fmt(k.tv-cv)}</span></div>
    <div class="result-line"><span class="label">Egresos operativos</span><span style="color:var(--caramel)">${fmt(k.te)}</span></div>
    <div class="result-line" style="border-top:2px solid var(--border);font-weight:700">
      <span class="label">Utilidad Neta</span><span style="color:${k.util>=0?'var(--sage)':'var(--rose)'}">${fmt(k.util)}</span>
    </div>`;
  const rec=[...state.ventas].sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).slice(0,6);
  document.getElementById('tabla-ult-ventas').innerHTML=rec.map(v=>`<tr><td><strong>${v.producto}</strong></td><td>${v.cantidad}</td><td>${fmt(v.precio)}</td><td>${fmt(v.precio*v.cantidad)}</td><td>${v.fecha}</td></tr>`).join('');
}

function renderIngredientes(){
  document.getElementById('ing-count').textContent=state.ingredientes.length;
  document.getElementById('tabla-ingredientes').innerHTML=state.ingredientes.map(ing=>`
    <tr>
      <td><strong>${ing.nombre}</strong></td>
      <td><span class="pill pill-lavender">${ing.cat}</span></td>
      <td>${fmt(ing.precioBase)} / <span class="unit-badge">${labelBase(ing.unidadBase)}</span></td>
      <td class="ing-calc-col">‚úÖ ${fmt(ing.precio)} / ${unidadMin(ing.unidadBase)}</td>
      <td style="color:var(--muted);font-size:.8rem">${ing.updated}</td>
      <td style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-edit" onclick="abrirEditarIngrediente(${ing.id})">‚úèÔ∏è Actualizar</button>
        <button class="btn btn-danger" onclick="eliminarIngrediente(${ing.id})">‚úï</button>
      </td>
    </tr>`).join('');
}

function renderCalculadora(){
  const search=(document.getElementById('calc-search')||{}).value||'';
  const filtered=state.ingredientes.filter(i=>i.nombre.toLowerCase().includes(search.toLowerCase()));
  document.getElementById('ingredients-calc-list').innerHTML=filtered.map(ing=>`
    <div class="ingredient-row">
      <input type="checkbox" class="ing-check" id="chk-${ing.id}" onchange="calcularPrecio()">
      <div style="flex:1"><div class="ing-name">${ing.nombre}</div><div class="ing-price">${fmt(ing.precio)} por ${unidadMin(ing.unidadBase)}</div></div>
      <input type="number" class="ing-qty" id="qty-${ing.id}" value="100" min="0" step="1" oninput="calcularPrecio()">
      <span class="ing-unit">${unidadMin(ing.unidadBase)}</span>
      <div class="ing-subtotal" id="sub-${ing.id}">‚Äî</div>
    </div>`).join('')||'<div style="color:var(--muted);padding:10px">Sin resultados</div>';
  calcularPrecio();
}

function calcularPrecio(){
  let costoUSD=0; const sels=[];
  state.ingredientes.forEach(ing=>{
    const chk=document.getElementById('chk-'+ing.id);
    const qty=document.getElementById('qty-'+ing.id);
    const sub=document.getElementById('sub-'+ing.id);
    if(!chk||!qty||!sub) return;
    if(chk.checked){
      const q=parseFloat(qty.value)||0; const s=q*ing.precio; costoUSD+=s;
      sels.push({nombre:ing.nombre,qty:q,unidad:unidadMin(ing.unidadBase),subtotal:s});
      sub.textContent=fmt(s);
    } else sub.textContent='‚Äî';
  });
  const extraUSD=parseFloat(document.getElementById('calc-extra').value)||0;
  const totalUSD=costoUSD+extraUSD;
  const margen=parseInt(document.getElementById('margin-slider').value)||50;
  const pvUSD=totalUSD*(1+margen/100);
  const ganUSD=pvUSD-totalUSD;
  document.getElementById('margen-label').textContent=margen+'%';
  document.getElementById('calc-costo-ing').textContent=fmt(costoUSD);
  document.getElementById('calc-costo-total').textContent=fmt(totalUSD);
  document.getElementById('calc-precio-venta').textContent=fmt(pvUSD);
  document.getElementById('calc-ganancia').textContent=fmt(ganUSD);
  document.getElementById('selected-ingredients-list').innerHTML=sels.length
    ?sels.map(s=>`<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px dashed var(--border2)"><span>${s.nombre} (${s.qty} ${s.unidad})</span><span style="color:var(--rose-dark);font-weight:600">${fmt(s.subtotal)}</span></div>`).join('')
    :'<span style="color:var(--muted)">‚Üê Selecciona ingredientes</span>';
}

function guardarReceta(){
  const nombre=document.getElementById('recipe-name').value.trim()||'Receta sin nombre';
  const sels=[];let costoUSD=0;
  state.ingredientes.forEach(ing=>{
    const chk=document.getElementById('chk-'+ing.id); const qty=document.getElementById('qty-'+ing.id);
    if(!chk||!qty||!chk.checked) return;
    const q=parseFloat(qty.value)||0; const s=q*ing.precio; costoUSD+=s;
    sels.push({nombre:ing.nombre,qty:q,unidad:unidadMin(ing.unidadBase),subtotal:s});
  });
  const extra=parseFloat(document.getElementById('calc-extra').value)||0;
  const total=costoUSD+extra;
  const margen=parseInt(document.getElementById('margin-slider').value)||50;
  const pv=total*(1+margen/100);
  if(!sels.length) return alert('Selecciona al menos un ingrediente.');
  state.recetas.push({id:nextId++,nombre,ingredientes:sels,costoTotal:total,margen,precioVenta:pv,fecha:new Date().toISOString().split('T')[0]});
  renderRecetas();
  scheduleSave();
  alert('‚úÖ Receta "'+nombre+'" guardada y sincronizada ‚òÅÔ∏è');
}

function limpiarCalculadora(){
  state.ingredientes.forEach(ing=>{
    const c=document.getElementById('chk-'+ing.id); const q=document.getElementById('qty-'+ing.id);
    if(c) c.checked=false; if(q) q.value=100;
  });
  document.getElementById('recipe-name').value='';
  document.getElementById('calc-extra').value='0';
  document.getElementById('margin-slider').value=50;
  calcularPrecio();
}

function renderRecetas(){
  document.getElementById('recetas-count').textContent=state.recetas.length;
  const c=document.getElementById('recetas-guardadas');
  if(!state.recetas.length){c.innerHTML='<div style="color:var(--muted);font-size:.85rem;padding:10px">A√∫n no hay recetas guardadas. ¬°Usa la calculadora! üéÇ</div>';return;}
  c.innerHTML=state.recetas.map(r=>`
    <div class="recipe-card">
      <div class="recipe-card-name">üéÇ ${r.nombre}</div>
      <div style="font-size:.8rem;color:var(--muted);margin-bottom:12px">${r.ingredientes.length} ingredientes ¬∑ ${r.fecha}</div>
      <div style="display:flex;justify-content:space-between;font-size:.84rem;margin-bottom:6px"><span style="color:var(--text2)">Costo total:</span><span style="font-weight:600">${fmt(r.costoTotal)}</span></div>
      <div style="display:flex;justify-content:space-between;font-size:.84rem;margin-bottom:6px"><span style="color:var(--text2)">Margen:</span><span class="pill pill-sage">${r.margen}%</span></div>
      <div style="display:flex;justify-content:space-between;font-size:1rem;font-weight:700;color:var(--rose-dark)"><span>Precio sugerido:</span><span>${fmt(r.precioVenta)}</span></div>
      <button class="btn btn-danger" style="margin-top:12px;width:100%;border-radius:10px" onclick="eliminarReceta(${r.id})">Eliminar receta</button>
    </div>`).join('');
}
function eliminarReceta(id){state.recetas=state.recetas.filter(r=>r.id!==id);renderRecetas();scheduleSave();}

function renderVentas(){
  document.getElementById('ventas-count-badge').textContent=state.ventas.length;
  const sorted=[...state.ventas].sort((a,b)=>new Date(b.fecha)-new Date(a.fecha));
  document.getElementById('tabla-ventas').innerHTML=sorted.map(v=>{
    const g=(v.precio-v.costo)*v.cantidad; const m=v.precio?((v.precio-v.costo)/v.precio*100).toFixed(0):0;
    return `<tr><td><strong>${v.producto}</strong></td><td>${v.cantidad}</td><td>${fmt(v.precio)}</td><td style="color:var(--caramel)">${fmt(v.costo)}</td>
      <td><span class="pill ${g>=0?'pill-sage':'pill-red'}">${fmt(g)} (${m}%)</span></td>
      <td style="font-weight:700">${fmt(v.precio*v.cantidad)}</td><td>${v.fecha}</td>
      <td><button class="btn btn-danger" onclick="eliminarVenta(${v.id})">‚úï</button></td></tr>`;}).join('');
  const p=parseFloat(document.getElementById('venta-precio').value)||0;
  const c=parseFloat(document.getElementById('venta-costo').value)||0;
  const cant=parseInt(document.getElementById('venta-cant').value)||1;
  document.getElementById('venta-preview').textContent=p?`Total: ${fmt(p*cant)} | Ganancia: ${fmt((p-c)*cant)}`:'';
}

function renderEgresos(){
  const sorted=[...state.egresos].sort((a,b)=>new Date(b.fecha)-new Date(a.fecha));
  document.getElementById('tabla-egresos').innerHTML=sorted.map(e=>`
    <tr><td>${e.concepto}</td><td><span class="pill pill-caramel">${e.cat}</span></td>
    <td style="color:var(--caramel);font-weight:600">${fmt(e.monto)}</td><td>${e.fecha}</td>
    <td><button class="btn btn-danger" onclick="eliminarEgreso(${e.id})">‚úï</button></td></tr>`).join('');
  const cats={};
  state.egresos.forEach(e=>cats[e.cat]=(cats[e.cat]||0)+e.monto);
  const total=Object.values(cats).reduce((s,v)=>s+v,0)||1;
  const pal=['var(--rose)','var(--sage)','var(--caramel)','var(--lavender)','var(--blush)'];
  let ci=0;
  document.getElementById('egresos-por-cat').innerHTML=Object.entries(cats).map(([cat,val])=>{
    const p=(val/total*100).toFixed(0); const col=pal[ci++%pal.length];
    return `<div style="margin-bottom:14px"><div style="display:flex;justify-content:space-between;font-size:.82rem;margin-bottom:4px"><span style="color:var(--text2)">${cat}</span><span style="font-weight:600">${fmt(val)}</span></div><div class="stock-bar" style="height:8px"><div class="stock-fill" style="width:${p}%;background:${col}"></div></div></div>`;}).join('');
}

function renderInventario(){
  const al=state.inventario.filter(i=>i.stock<=i.min);
  document.getElementById('inv-alertas').innerHTML=al.map(i=>`<div class="alert alert-danger">‚ö†Ô∏è Stock bajo: <strong>${i.nombre}</strong> ‚Äî ${i.stock} ${i.unidad} (m√≠n: ${i.min})</div>`).join('');
  document.getElementById('tabla-inventario').innerHTML=state.inventario.map(inv=>{
    const p=Math.min((inv.stock/Math.max(inv.min*2,1))*100,100);
    const col=inv.stock<=inv.min?'var(--rose)':inv.stock<=inv.min*1.5?'var(--caramel)':'var(--sage)';
    return `<tr><td><strong>${inv.nombre}</strong></td><td>${inv.stock} ${inv.unidad}</td><td>${inv.min} ${inv.unidad}</td>
      <td>${fmt(inv.costo)}</td><td style="font-weight:600">${fmt(inv.stock*inv.costo)}</td>
      <td style="min-width:90px"><div class="stock-bar"><div class="stock-fill" style="width:${p}%;background:${col}"></div></div></td>
      <td style="display:flex;gap:6px"><button class="btn btn-edit" onclick="editarStockInv(${inv.id})">Editar</button><button class="btn btn-danger" onclick="eliminarInv(${inv.id})">‚úï</button></td></tr>`;}).join('');
}

function renderTopProductos(){
  const byProd={};
  state.ventas.forEach(v=>{
    if(!byProd[v.producto]) byProd[v.producto]={unidades:0,ingresos:0,precio:v.precio,costo:v.costo};
    byProd[v.producto].unidades+=v.cantidad; byProd[v.producto].ingresos+=v.precio*v.cantidad;
  });
  const top=Object.entries(byProd).sort((a,b)=>b[1].ingresos-a[1].ingresos).slice(0,6);
  const medals=['ü•á','ü•à','ü•â','4¬∞','5¬∞','6¬∞'];
  document.getElementById('tabla-top-ventas').innerHTML=top.map(([n,d],i)=>`
    <tr><td>${medals[i]}</td><td><strong>${n}</strong></td><td>${d.unidades}</td><td style="color:var(--rose-dark);font-weight:700">${fmt(d.ingresos)}</td></tr>`).join('')||'<tr><td colspan="4" style="text-align:center;color:var(--muted)">Sin datos a√∫n</td></tr>';
  const topM=Object.entries(byProd).sort((a,b)=>(b[1].precio-b[1].costo)/b[1].precio-(a[1].precio-a[1].costo)/a[1].precio).slice(0,5);
  document.getElementById('tabla-top-margen').innerHTML=topM.map(([n,d])=>{
    const m=((d.precio-d.costo)/d.precio*100).toFixed(0);
    return `<tr><td><strong>${n}</strong></td><td>${fmt(d.precio)}</td><td>${fmt(d.costo)}</td><td><span class="pill pill-sage">${m}%</span></td></tr>`;}).join('');
  const maxI=Math.max(...top.map(t=>t[1].ingresos),1);
  const pal=['var(--rose)','var(--blush)','var(--sage)','var(--lavender)','var(--caramel)','#c0b0e0'];
  document.getElementById('bar-top-tortas').innerHTML=top.map(([n,d],i)=>`
    <div class="bar-wrap"><div class="bar" style="height:${(d.ingresos/maxI*100).toFixed(0)}%;background:${pal[i%6]}" title="${fmt(d.ingresos)}"></div>
    <div class="bar-label" style="text-align:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;max-width:50px">${n.split(' ')[0]}</div></div>`).join('');
}

function renderUtilidades(){
  const tv=state.ventas.reduce((s,v)=>s+v.precio*v.cantidad,0);
  const te=state.egresos.reduce((s,e)=>s+e.monto,0);
  const cv=state.ventas.reduce((s,v)=>s+v.costo*v.cantidad,0);
  const un=tv-te-cv; const m=tv?(un/tv*100):0;
  document.getElementById('util-ingresos').textContent=fmt(tv);
  document.getElementById('util-egresos').textContent=fmt(te+cv);
  document.getElementById('util-neta').textContent=fmt(un);
  document.getElementById('util-margen').textContent=pct(m);
  const rows=[
    ['üíµ Ingresos por Ventas',tv,'var(--rose-dark)'],['üßÅ Costo de Producci√≥n',-cv,'var(--caramel)'],
    ['‚ú® Utilidad Bruta',tv-cv,'var(--sage)'],['üì§ Gastos Operativos',-te,'var(--caramel)'],
    ['üå∏ Utilidad Neta',un,un>=0?'var(--sage)':'var(--rose)'],['üìä Margen Neto',pct(m),'var(--lavender)'],
  ];
  document.getElementById('tabla-resultados').innerHTML=rows.map(([l,v,c],i)=>`
    <tr style="${i===2||i===4?'border-top:2px solid var(--border)':''}${i===2||i===4?';font-weight:700':''}">
      <td style="color:var(--text2);padding:10px 12px">${l}</td>
      <td style="text-align:right;padding:10px 12px;color:${c};font-weight:${i>=2?700:400}">${typeof v==='string'?v:fmt(v)}</td></tr>`).join('');
  const dias={};
  state.ventas.forEach(v=>dias[v.fecha]=(dias[v.fecha]||0)+v.precio*v.cantidad);
  const vals=Object.entries(dias).sort((a,b)=>a[0]<b[0]?-1:1).slice(-14);
  const maxV=Math.max(...vals.map(v=>v[1]),.01);
  document.getElementById('bar-utilidades').innerHTML=vals.map(([d,v])=>`
    <div class="bar-wrap"><div class="bar" style="height:${(v/maxV*100).toFixed(0)}%" title="${fmt(v)}"></div><div class="bar-label">${new Date(d).getDate()}</div></div>`).join('');
}

// ========== INGREDIENTES ACTIONS ==========
function actualizarLabelPrecio(){
  const base=document.getElementById('ing-unidad-base').value;
  const labels={kg:'Precio por kg (USD)',litro:'Precio por litro (USD)',docena:'Precio por docena (USD)',unidad:'Precio por unidad (USD)'};
  document.getElementById('ing-precio-label').textContent=labels[base];
  mostrarPrevioIngrediente();
}
function mostrarPrevioIngrediente(){
  const base=document.getElementById('ing-unidad-base').value;
  const pb=parseFloat(document.getElementById('ing-precio-base').value)||0;
  if(!pb){document.getElementById('ing-calc-preview').style.display='none';return;}
  const pUnit=calcPxU(pb,base); const um=unidadMin(base);
  document.getElementById('ing-calc-text').innerHTML=
    `üí° <strong>${fmt(pb)}</strong> / ${labelBase(base)} = <strong>${fmt(pUnit)} por ${um}</strong> (calculado autom√°ticamente)`;
  document.getElementById('ing-calc-preview').style.display='block';
}
function agregarIngrediente(){
  const n=document.getElementById('ing-nombre').value.trim();
  const base=document.getElementById('ing-unidad-base').value;
  const pb=parseFloat(document.getElementById('ing-precio-base').value);
  const cat=document.getElementById('ing-cat').value;
  if(!n||isNaN(pb)||pb<=0) return alert('Completa el nombre y el precio del ingrediente.');
  state.ingredientes.push({id:nextId++,nombre:n,unidadBase:base,precioBase:pb,precio:calcPxU(pb,base),cat,updated:new Date().toISOString().split('T')[0]});
  document.getElementById('ing-nombre').value='';
  document.getElementById('ing-precio-base').value='';
  document.getElementById('ing-calc-preview').style.display='none';
  afterMutation();
}
function eliminarIngrediente(id){
  state.ingredientes=state.ingredientes.filter(i=>i.id!==id);
  deleteFromDb('ingredientes', id);
  afterMutation();
}

function eliminarVenta(id){
  state.ventas=state.ventas.filter(v=>v.id!==id);
  deleteFromDb('ventas', id);
  afterMutation();
}
function eliminarEgreso(id){
  state.egresos=state.egresos.filter(e=>e.id!==id);
  deleteFromDb('egresos', id);
  afterMutation();
}
function eliminarInv(id){
  state.inventario=state.inventario.filter(i=>i.id!==id);
  deleteFromDb('inventario', id);
  afterMutation();
}

document.addEventListener('input',e=>{
  if(['venta-precio','venta-costo','venta-cant'].includes(e.target.id)) renderVentas();
});

// ========== INIT WITH SUPABASE AUTH ==========
let authInitialized = false;

sb.auth.onAuthStateChange(async (event, session) => {
  const loading = document.getElementById('login-loading');

  // Solo actuar en eventos relevantes
  if (event === 'SIGNED_OUT') {
    currentUser = null;
    resetState();
    Object.keys(idMap).forEach(k => idMap[k] = {});
    document.getElementById('app-screen').style.display = 'none';
    document.getElementById('login-screen').style.display = 'flex';
    if (loading) loading.style.display = 'none';
    return;
  }

  if (session && session.user) {
    const isFirstLoad = !authInitialized;
    authInitialized = true;
    currentUser = session.user;
    if (loading) loading.style.display = 'none';
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-screen').style.display = 'block';
    initDate();
    // Siempre cargar datos desde Supabase al iniciar o recargar
    await loadAll();
  }
});

// Verificar sesi√≥n existente al cargar la p√°gina
(async () => {
  const { data } = await sb.auth.getSession();
  if (!data.session) {
    // No hay sesi√≥n, mostrar login
    const loading = document.getElementById('login-loading');
    if (loading) loading.style.display = 'none';
    document.getElementById('login-screen').style.display = 'flex';
  }
  // Si hay sesi√≥n, onAuthStateChange lo manejar√° autom√°ticamente
})();

function abrirEditarIngrediente(id){
  const ing=state.ingredientes.find(i=>i.id===id);
  const precioLabels={kg:'Nuevo precio por kg (USD)',litro:'Nuevo precio por litro (USD)',docena:'Nuevo precio por docena (USD)',unidad:'Nuevo precio por unidad (USD)'};
  document.getElementById('edit-ing-id').value=id;
  document.getElementById('edit-ing-nombre').value=ing.nombre;
  document.getElementById('edit-ing-precio-old').value=fmt(ing.precioBase)+' / '+labelBase(ing.unidadBase);
  document.getElementById('edit-ing-precio-label').textContent=precioLabels[ing.unidadBase]||'Nuevo Precio (USD)';
  document.getElementById('edit-ing-precio-new').value='';
  document.getElementById('edit-calc-preview').textContent='';
  document.getElementById('edit-ing-precio-new').oninput=function(){
    const np=parseFloat(this.value)||0;
    if(np>0) document.getElementById('edit-calc-preview').textContent=`‚Üí Precio por ${unidadMin(ing.unidadBase)}: ${fmt(calcPxU(np,ing.unidadBase))}`;
  };
  document.getElementById('modal-edit-ing').classList.add('open');
}
function closeModal(){document.getElementById('modal-edit-ing').classList.remove('open');}
function guardarPrecioIngrediente(){
  const id=parseInt(document.getElementById('edit-ing-id').value);
  const np=parseFloat(document.getElementById('edit-ing-precio-new').value);
  if(isNaN(np)||np<=0) return alert('Ingresa un precio v√°lido mayor a 0.');
  const ing=state.ingredientes.find(i=>i.id===id);
  const old=ing.precioBase;
  ing.precioBase=np; ing.precio=calcPxU(np,ing.unidadBase);
  ing.updated=new Date().toISOString().split('T')[0];
  closeModal();
  const cambio=((np-old)/old*100).toFixed(1);
  alert(np>old?`‚¨ÜÔ∏è Precio actualizado. Subi√≥ un ${cambio}%.`:`‚¨áÔ∏è Precio actualizado. Baj√≥ un ${Math.abs(cambio)}%.`);
  afterMutation();
}

// ========== OTHER ACTIONS ==========
function agregarVenta(){
  const prod=document.getElementById('venta-prod').value.trim();
  const cant=parseInt(document.getElementById('venta-cant').value)||1;
  const precio=parseFloat(document.getElementById('venta-precio').value);
  const costo=parseFloat(document.getElementById('venta-costo').value)||0;
  const fecha=document.getElementById('venta-fecha').value;
  if(!prod||!precio) return alert('Completa el producto y el precio.');
  state.ventas.push({id:nextId++,producto:prod,cantidad:cant,precio,costo,fecha});
  document.getElementById('venta-prod').value=''; document.getElementById('venta-precio').value=''; document.getElementById('venta-costo').value='';
  afterMutation();
}
function eliminarVenta(id){state.ventas=state.ventas.filter(v=>v.id!==id);deleteFromDb('ventas',id);afterMutation();}
function agregarEgreso(){
  const concepto=document.getElementById('egr-concepto').value.trim();
  const cat=document.getElementById('egr-cat').value;
  const monto=parseFloat(document.getElementById('egr-monto').value);
  const fecha=document.getElementById('egr-fecha').value;
  if(!concepto||isNaN(monto)) return alert('Completa concepto y monto.');
  state.egresos.push({id:nextId++,concepto,cat,monto,fecha});
  document.getElementById('egr-concepto').value=''; document.getElementById('egr-monto').value='';
  afterMutation();
}
function eliminarEgreso(id){state.egresos=state.egresos.filter(e=>e.id!==id);deleteFromDb('egresos',id);afterMutation();}
function agregarInventario(){
  const n=document.getElementById('inv-nombre').value.trim();
  const u=document.getElementById('inv-unidad').value;
  const s=parseFloat(document.getElementById('inv-stock').value)||0;
  const m=parseFloat(document.getElementById('inv-min').value)||0;
  const c=parseFloat(document.getElementById('inv-costo').value)||0;
  if(!n) return alert('Escribe el nombre del insumo.');
  state.inventario.push({id:nextId++,nombre:n,unidad:u,stock:s,min:m,costo:c});
  document.getElementById('inv-nombre').value=''; document.getElementById('inv-stock').value=''; document.getElementById('inv-min').value=''; document.getElementById('inv-costo').value='';
  afterMutation();
}
function eliminarInv(id){state.inventario=state.inventario.filter(i=>i.id!==id);deleteFromDb('inventario',id);afterMutation();}
function editarStockInv(id){
  const inv=state.inventario.find(i=>i.id===id);
  const v=prompt(`Stock de ${inv.nombre}: ${inv.stock} ${inv.unidad}\nNuevo stock:`,inv.stock);
  if(v!==null&&!isNaN(parseFloat(v))){inv.stock=parseFloat(v);afterMutation();}
}

</script>
</body>
</html>
